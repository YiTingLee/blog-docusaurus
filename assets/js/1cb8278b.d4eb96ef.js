"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[728],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>m});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var p=r.createContext({}),c=function(e){var t=r.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},d=function(e){var t=c(e.components);return r.createElement(p.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},s=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,p=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),s=c(n),m=a,k=s["".concat(p,".").concat(m)]||s[m]||u[m]||i;return n?r.createElement(k,o(o({ref:t},d),{},{components:n})):r.createElement(k,o({ref:t},d))}));function m(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,o=new Array(i);o[0]=s;var l={};for(var p in t)hasOwnProperty.call(t,p)&&(l[p]=t[p]);l.originalType=e,l.mdxType="string"==typeof e?e:a,o[1]=l;for(var c=2;c<i;c++)o[c]=n[c];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}s.displayName="MDXCreateElement"},9369:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>o,default:()=>u,frontMatter:()=>i,metadata:()=>l,toc:()=>c});var r=n(7462),a=(n(7294),n(3905));const i={title:"Docker Image Minimization",date:"2021-07-17T17:00:00.000Z",template:"post",draft:!1,slug:"docker-image-minimization",category:"Docker",tags:["Docker","Optimization"],description:"Docker image\u6e1b\u80a5\u5927\u4f5c\u6230!!",socialImage:""},o=void 0,l={unversionedId:"Docker/Docker-Image-Minimization",id:"Docker/Docker-Image-Minimization",title:"Docker Image Minimization",description:"Docker image\u6e1b\u80a5\u5927\u4f5c\u6230!!",source:"@site/docs/Docker/5-Docker-Image-Minimization.md",sourceDirName:"Docker",slug:"/Docker/docker-image-minimization",permalink:"/Docker/docker-image-minimization",draft:!1,tags:[{label:"Docker",permalink:"/tags/docker"},{label:"Optimization",permalink:"/tags/optimization"}],version:"current",lastUpdatedAt:1662134863,formattedLastUpdatedAt:"Sep 2, 2022",sidebarPosition:5,frontMatter:{title:"Docker Image Minimization",date:"2021-07-17T17:00:00.000Z",template:"post",draft:!1,slug:"docker-image-minimization",category:"Docker",tags:["Docker","Optimization"],description:"Docker image\u6e1b\u80a5\u5927\u4f5c\u6230!!",socialImage:""},sidebar:"defaultSidebar",previous:{title:"Docker",permalink:"/category/docker"},next:{title:"Design Pattern",permalink:"/category/design-pattern"}},p={},c=[{value:"\u4ecb\u7d39",id:"\u4ecb\u7d39",level:2},{value:"\u7b2c\u4e00\u8f2a: \u6e96\u5099",id:"\u7b2c\u4e00\u8f2a-\u6e96\u5099",level:2},{value:"\u70ba\u4ec0\u9ebc\u9019\u9ebc\u5927?",id:"\u70ba\u4ec0\u9ebc\u9019\u9ebc\u5927",level:4},{value:"\u7b2c\u4e8c\u8f2a: \u62ff\u6389\u975e\u5fc5\u8981\u6a94\u6848",id:"\u7b2c\u4e8c\u8f2a-\u62ff\u6389\u975e\u5fc5\u8981\u6a94\u6848",level:2},{value:"\u90a3\u600e\u9ebc\u8fa6?",id:"\u90a3\u600e\u9ebc\u8fa6",level:4},{value:"\u611f\u89ba\u9084\u662f\u5f88\u5927?",id:"\u611f\u89ba\u9084\u662f\u5f88\u5927",level:4},{value:"\u7b2c\u4e09\u8f2a: \u4f7f\u7528\u8f15\u91cf\u5316\u7684 Node \u7248\u672c alpine",id:"\u7b2c\u4e09\u8f2a-\u4f7f\u7528\u8f15\u91cf\u5316\u7684-node-\u7248\u672c-alpine",level:2},{value:"\u7d50\u8ad6",id:"\u7d50\u8ad6",level:2},{value:"Source Code",id:"source-code",level:2}],d={toc:c};function u(e){let{components:t,...i}=e;return(0,a.kt)("wrapper",(0,r.Z)({},d,i,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h2",{id:"\u4ecb\u7d39"},"\u4ecb\u7d39"),(0,a.kt)("p",null,"\u5728\u4e0a\u50b3\u6216\u4e0b\u8f09 docker image \u7684\u6642\u5019\uff0c\u5927\u5bb6\u6216\u591a\u6216\u5c11\u90fd\u61c9\u8a72\u6709\u9047\u904e Timeout \u6216\u662f\u4e0a\u50b3\u901f\u5ea6\u5f88\u6162\u7b49\u554f\u984c\uff0c\u66f4\u751a\u81f3\u6709\u6642\u5019\u662f\u628a docker image \u62c9\u5230 IOT \u88dd\u7f6e\u4e0a\u9762\u8dd1\uff0c\u5148\u5929\u689d\u4ef6\u4e0a\u6a5f\u5668\u5c31\u7121\u6cd5\u5bb9\u7d0d\u6c92\u6e1b\u80a5\u904e\u7684 docker image\uff0c\u800c\u7e2e\u5c0f docker image \u7684\u5927\u5c0f\u662f\u907f\u514d\u9019\u4e9b\u554f\u984c\u7684\u65b9\u6cd5\u4e4b\u4e00\uff0c\u4e5f\u662f\u6211\u5011\u4eca\u5929\u8981\u505a\u7684\u4e3b\u8981\u5be6\u9a57\u3002"),(0,a.kt)("p",null,"\u4eca\u5929\u7684\u5be6\u9a57\u4e3b\u8981\u662f\u4f7f\u7528 Nest \u9019\u500b\u6846\u67b6\u5efa\u7acb\u51fa\u4f86\u7684 service \u4f86\u505a\u70ba\u6211\u5011\u7e2e\u5c0f\u7684\u4e3b\u8981\u5c0d\u8c61\u3002\u96d6\u7136\u662f\u4f7f\u7528 Nest \u4f5c\u70ba\u7bc4\u4f8b\uff0c\u4f46\u9019\u4e9b\u65b9\u6cd5\u548c\u6982\u5ff5\u90fd\u53ef\u4ee5\u9069\u7528\u5728\u4e0d\u540c\u7684\u5c08\u6848\u4e0a\u3002"),(0,a.kt)("h2",{id:"\u7b2c\u4e00\u8f2a-\u6e96\u5099"},"\u7b2c\u4e00\u8f2a: \u6e96\u5099"),(0,a.kt)("p",null,"\u7528 Nest \u5efa\u4e00\u500b\u57fa\u672c\u7684\u5c08\u6848\u5427"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"$ nest new nest-playground\n")),(0,a.kt)("p",null,"\u6211\u5011\u6703\u5f97\u5230\u4e00\u500b\u5b8c\u6574 Nest \u7684 App, \u770b\u8d77\u6703\u50cf\u9019\u6a23\n",(0,a.kt)("img",{alt:"Folder Structure",src:n(7705).Z,width:"754",height:"880"})),(0,a.kt)("p",null,"\u63a5\u8457\u7528\u6700\u57fa\u672c\u7684\u65b9\u6cd5\u5305\u6210 docker image \u5427"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"nest-playground \u7684\u5c08\u6848\u4e0b\u5efa\u7acb Dockerfile")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-Dockerfile"},'FROM node:12\n\nWORKDIR /app\n\nCOPY . .\n\nRUN yarn install\n\nEXPOSE 3000\n\nCMD ["yarn", "start"]\n')),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"build docker image \u6307\u4ee4\u5982\u4e0b")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"$ docker build -t nest-backend .\n")),(0,a.kt)("p",null,"\u9019\u6a23 build \u51fa\u4f86\u7684 docker-image \u7e3d\u5171\u4f7f\u7528\u4e86*",(0,a.kt)("strong",{parentName:"p"},"*1.6G**"),"\uff0c\u6bd4\u9810\u60f3\u4e2d\u5927\u5f88\u591a\u5427"),(0,a.kt)("h4",{id:"\u70ba\u4ec0\u9ebc\u9019\u9ebc\u5927"},"\u70ba\u4ec0\u9ebc\u9019\u9ebc\u5927?"),(0,a.kt)("p",null,"\u56e0\u70ba\u6211\u5011\u628a\u6574\u500b repo\uff0cnode_modules\uff0c\u4ee5\u53ca\u5be6\u969b build \u51fa\u4f86\u7684 js \u90fd\u5305\u5728\u9019\u5305 image \u5167\u4e86"),(0,a.kt)("h2",{id:"\u7b2c\u4e8c\u8f2a-\u62ff\u6389\u975e\u5fc5\u8981\u6a94\u6848"},"\u7b2c\u4e8c\u8f2a: \u62ff\u6389\u975e\u5fc5\u8981\u6a94\u6848"),(0,a.kt)("h4",{id:"\u90a3\u600e\u9ebc\u8fa6"},"\u90a3\u600e\u9ebc\u8fa6?"),(0,a.kt)("p",null,"\u9019\u908a\u5148\u628a\u5fc5\u8981\u7684\u7a0b\u5f0f\u7559\u4e0b\u4f86\uff0c\u5176\u4ed6\u975e\u5fc5\u8981\u7684\u6a94\u6848\u90fd\u62ff\u6389\uff0c\u5305\u542b source code\uff0c\u4e5f\u5c31\u662f\u8aaa\u9664\u4e86 build \u51fa\u4f86\u7684 dist \u5916\u5176\u4ed6\u6a94\u6848\u90fd\u4e0d\u9700\u8981\u5b58\u5728"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"\u628a Dockerfile \u5206\u6210\u5169\u500b stage",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"stage1 \u8ca0\u8cac build code"),(0,a.kt)("li",{parentName:"ul"},"stage2 \u5247\u8ca0\u8cac\u628a stage1 build \u597d\u7684\u7a0b\u5f0f copy \u9032\u53bb stage2 \u5167\u7136\u5f8c run \u8d77\u4f86")))),(0,a.kt)("p",null,"\u7d93\u904e\u9019\u4e9b\u8655\u7406\u5f8c\uff0cstage2(\u4e5f\u5c31\u6700\u5f8c\u8981 run \u8d77\u7684 image)\u5167\u53ea\u6703\u5305\u542b dist \u5167\u5bb9\uff0c\u4efb\u4f55 repo \u5167\u7684\u8cc7\u6599\u90fd\u6703\u88ab\u7559\u5728 stage1 \u88e1\u9762\uff0c\u4e26\u4e0d\u6703\u88ab\u653e\u5230 stage2 \u5167\uff0c\u5be6\u4f5c\u5982\u4e0b\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-Dockerfile"},'# STAGE 1\n\nFROM node:12 AS build\n\nWORKDIR /app\n\nCOPY . .\n\nRUN yarn install\n\nCMD ["yarn", "build:prod"]\n\n# STAGE 2\n\nFROM node:12\n\nWORKDIR /app\n\nCOPY --from=build /app/package.json .\nCOPY --from=build /app/dist ./dist\n\nEXPOSE 3000\n\nCMD ["yarn", "start:prod"]\n')),(0,a.kt)("p",null,"\u9019\u908a\u70ba\u4e86\u5c07 node_modules \u5167\u6c92\u4f7f\u7528\u5230\u7684\u6771\u897f\u62ff\u6389\uff0c\u6211\u5011\u4f7f\u7528\u4e86 webpack \u4f86\u8655\u7406\uff0c",(0,a.kt)("a",{parentName:"p",href:"https://github.com/YiTingLee/NestAppMinimization/blob/master/webpack.config.js"},"Webpack Config"),"\u5728\u9019\u908a\u3002"),(0,a.kt)("p",null,"\u9019\u6a23\u8655\u7406\u5b8c\u7684 docker image \u5269\u4e0b*",(0,a.kt)("strong",{parentName:"p"},"*919MB**")),(0,a.kt)("h4",{id:"\u611f\u89ba\u9084\u662f\u5f88\u5927"},"\u611f\u89ba\u9084\u662f\u5f88\u5927?"),(0,a.kt)("h2",{id:"\u7b2c\u4e09\u8f2a-\u4f7f\u7528\u8f15\u91cf\u5316\u7684-node-\u7248\u672c-alpine"},"\u7b2c\u4e09\u8f2a: \u4f7f\u7528\u8f15\u91cf\u5316\u7684 Node \u7248\u672c alpine"),(0,a.kt)("p",null,"\u6211\u5011\u4e00\u822c\u4f7f\u7528\u7684 node image \u662f Debian based \u7684\uff0c\u64c1\u6709\u5b8c\u6574\u7684\u529f\u80fd\uff0c\u5927\u5c0f\u7d04 650MB+\uff0c\u800c alpine \u50c5\u6709\u7dad\u6301\u904b\u4f5c\u6700\u57fa\u790e\u7684 OS \u529f\u80fd\uff0c\u751a\u81f3\u9023 Python/gcc \u90fd\u6c92\u6709\uff0c\u5927\u5c0f\u7d04 50MB+\u3002\u4f7f\u7528\u8f15\u91cf\u5316\u7684 node \u4e26\u4e0d\u662f\u5b8c\u5168\u6c92\u6709\u5f8c\u907a\u75c7\uff0c\u8f15\u91cf\u5316\u7684 image \u80af\u5b9a\u5c31\u662f\u62ff\u6389\u4e86\u8a31\u591a\u529f\u80fd\u53ca module\uff0c\u4f46\u5728 image size \u4e0a\u662f\u64c1\u6709\u5f88\u5927\u7684\u512a\u52e2\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-Dockerfile"},'# STAGE 1\n\nFROM node:12-alpine AS build\n\nWORKDIR /app\n\nCOPY . .\n\nRUN yarn install\n\nCMD ["yarn", "build:prod"]\n\n# STAGE 2\n\nFROM node:12-alpine\n\nWORKDIR /app\n\nCOPY --from=build /app/package.json .\nCOPY --from=build /app/dist ./dist\n\nEXPOSE 3000\n\nCMD ["yarn", "start:prod"]\n')),(0,a.kt)("p",null,"\u4f7f\u7528\u8f15\u91cf\u7248 Node build \u5b8c\u5f8c\u7684\u7e3d\u5927\u5c0f\u662f*",(0,a.kt)("strong",{parentName:"p"},"*90.5MB**")),(0,a.kt)("h2",{id:"\u7d50\u8ad6"},"\u7d50\u8ad6"),(0,a.kt)("p",null,"\u9019\u6b21\u7684\u5be6\u9a57\u5927\u5c0f\u7684\u9032\u5ea6\u5206\u5225\u662f 1.6GB -> 919MB -> 90.5MB\uff0c\u7e3d\u5171\u6e1b\u5c11\u4e86 17X\uff0c\u7576\u4e2d\u9664\u4e86 Dockerfile \u5728 Stage \u4e0a\u7684\u64cd\u4f5c\u5916\u9084\u6709\u4e00\u4e9b webpack \u7684\u4f7f\u7528\u624d\u80fd\u5927\u5e45\u5ea6\u7684\u6e1b\u5c11 image \u7684\u5927\u5c0f\u3002"),(0,a.kt)("p",null,"\u9019\u908a\u8981\u518d\u8aaa\u4e00\u6b21\uff0c\u96d6\u7136\u4eca\u5929\u7684\u5be6\u9a57\u4e3b\u8981\u662f\u4f7f\u7528 Nest \u9019\u500b\u6846\u67b6\u505a\u70ba\u6211\u5011\u7684\u4e3b\u8981\u7bc4\u4f8b\uff0c\u4f46\u9019\u4e9b\u65b9\u6cd5\u53ca\u6982\u5ff5\u90fd\u53ef\u4ee5\u5957\u7528\u5230\u4e0d\u540c\u7684\u5c08\u6848\u4e0a\uff0c\u5c24\u5176\u662f frontend \u7684\u5c08\u6848\u53e6\u5916\u9084\u53ef\u4ee5\u4f7f\u7528 nginx \u7b49\u8f15\u91cf\u5316\u7684 web server \u4f5c\u70ba\u57fa\u5e95\u3002"),(0,a.kt)("h2",{id:"source-code"},"Source Code"),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"https://github.com/YiTingLee/NestAppMinimization"},"https://github.com/YiTingLee/NestAppMinimization")))}u.isMDXComponent=!0},7705:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/folder-structure-48afb4fea2151df5a6351e90ef3ee425.png"}}]);